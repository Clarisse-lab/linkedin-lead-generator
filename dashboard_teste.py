import streamlit as st
import requests
import pandas as pd
import time
import json
from datetime import datetime

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="LinkedIn Lead Generator",
    page_icon="üéØ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS customizado
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #0e76a8;
        text-align: center;
        margin-bottom: 2rem;
    }
    .success-msg {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    .repeat-search-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 0.3rem 0.8rem;
        border-radius: 3px;
        font-size: 0.8rem;
        cursor: pointer;
    }
</style>
""", unsafe_allow_html=True)

# Header principal
st.markdown('<h1 class="main-header">üéØ LinkedIn Lead Generator</h1>', unsafe_allow_html=True)

# Sidebar - Configura√ß√µes
st.sidebar.header("üîç Par√¢metros de Busca")

# URL do webhook (oculto)
webhook_url = "https://n8n.srv845413.hstgr.cloud/webhook/linkedin-leads-claude"

# Campo livre para cargos
executive_input = st.sidebar.text_input(
    "üéØ Cargos/Termos de Busca",    
    help="Digite os cargos que deseja buscar (ex: CEO CMO diretor)"
)

# Filtro por Setor
sector_filter = st.sidebar.selectbox(
    "üè≠ Setor/Ind√∫stria",
    [
        "Todos os setores",
        "Tecnologia/SaaS",
        "E-commerce/Varejo", 
        "Servi√ßos Financeiros",
        "Sa√∫de/Farmac√™utico",
        "Educa√ß√£o/EdTech",
        "Imobili√°rio/PropTech",
        "Manufatura/Ind√∫stria",
        "Consultoria/Servi√ßos",
        "Marketing/Ag√™ncias",
        "Log√≠stica/Transporte"
    ],
    index=0
)

# Localiza√ß√£o expandida
location_options = [
    "Brasil",
    "S√£o Paulo", "Rio de Janeiro", "Belo Horizonte", "Porto Alegre", "Salvador",
    "Bras√≠lia", "Fortaleza", "Recife", "Curitiba", "Manaus",
    "Bel√©m", "Goi√¢nia", "Guarulhos", "Campinas", "S√£o Lu√≠s",
    "Macei√≥", "Campo Grande", "Teresina", "Jo√£o Pessoa", "Vit√≥ria"
]

location = st.sidebar.selectbox(
    "üìç Localiza√ß√£o",
    location_options,
    index=0
)

# N√∫mero de resultados
num_results = st.sidebar.slider("N√∫mero de Resultados", 5, 20, 10)

# P√°gina inicial
start_page = st.sidebar.number_input("P√°gina Inicial", 0, 50, 0)

# √Årea principal dividida em tabs
tab1, tab2, tab3, tab4 = st.tabs(["üöÄ Buscar Leads", "üìä Resultados", "üìà Analytics", "üìã Hist√≥rico"])

# Inicializar session state
if 'leads_data' not in st.session_state:
    st.session_state.leads_data = []
if 'search_history' not in st.session_state:
    st.session_state.search_history = []

# Fun√ß√£o para repetir busca
def repeat_search(search_data):
    """Fun√ß√£o para repetir uma busca anterior"""
    # Definir os valores nos campos
    st.session_state.executive_input = search_data.get('executive_terms', '')
    st.session_state.sector_filter = search_data.get('sector', 'Todos os setores')
    st.session_state.location = search_data.get('location', 'Brasil')
    # Redirecionar para a tab de busca
    st.info("üîÑ Par√¢metros da busca anterior carregados! V√° para a aba 'Buscar Leads' e clique em 'Iniciar Busca'.")

# TAB 1: Buscar Leads
with tab1:
    st.header("üîç Nova Busca de Leads")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.subheader("Configura√ß√£o da Busca")
        
        # Converter input em lista de termos
        executive_terms = [term.strip() for term in executive_input.split() if term.strip()]
        
        # Preview da query (oculto - s√≥ para processamento interno)
        query_terms = " OR ".join(executive_terms)
        sector_query = f" {sector_filter.split('/')[0].lower()}" if sector_filter != "Todos os setores" else ""
        query_preview = f"site:linkedin.com/in ({query_terms}){sector_query} {location}"
        
        # Informa√ß√µes da busca
        st.info(f"""
        **Configura√ß√£o Atual:**
        - üéØ Cargos: {', '.join(executive_terms)}
        - üè≠ Setor: {sector_filter}
        - üìç Local: {location}
        - üìä Resultados: {num_results}
        - üìÑ P√°gina: {start_page}
        """)
    
    with col2:
        st.subheader("A√ß√µes")
        
        # Bot√£o de busca
        if st.button("üöÄ Iniciar Busca", type="primary", use_container_width=True):
            if not executive_terms:
                st.error("‚ùå Digite pelo menos um cargo para buscar!")
            else:
                # Payload para o N8N
                payload = {
                    "query": query_preview,
                    "num_results": num_results,
                    "start_page": start_page,
                    "location": location,
                    "executive_terms": executive_terms,
                    "sector": sector_filter
                }
                
                # Progress bar
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                try:
                    status_text.text("üì° Enviando requisi√ß√£o para N8N...")
                    progress_bar.progress(25)
                    
                    # Chamada para o N8N
                    response = requests.post(webhook_url, json=payload, timeout=300)
                    progress_bar.progress(50)
                    
                    if response.status_code == 200:
                        status_text.text("‚úÖ Processando resultados...")
                        progress_bar.progress(75)
                        
                        # Simular delay de processamento
                        time.sleep(2)
                        
                        # Parse da resposta
                        result_data = response.json()
                        progress_bar.progress(100)
                        
                        # Ajustar para o formato do N8N Aggregate
                        if 'leads' in result_data:
                            leads = result_data['leads']
                            # Se leads √© um objeto com 'data', extrair o array
                            if isinstance(leads, dict) and 'data' in leads:
                                leads = leads['data']
                            # Se leads n√£o √© uma lista, transformar em lista
                            elif not isinstance(leads, list):
                                leads = [leads]
                        else:
                            leads = []
                        
                        # Calcular estat√≠sticas de potencial
                        alto_potencial = len([l for l in leads if 'ALTO' in l.get('analise', '')])
                        medio_potencial = len([l for l in leads if 'M√âDIO' in l.get('analise', '')])
                        baixo_potencial = len(leads) - alto_potencial - medio_potencial
                        
                        # Taxa de convers√£o (alto potencial / total)
                        conversion_rate = (alto_potencial / len(leads) * 100) if leads else 0
                        
                        # Salvar no session state
                        st.session_state.leads_data = leads
                        
                        # Adicionar ao hist√≥rico com estat√≠sticas detalhadas
                        st.session_state.search_history.append({
                            'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                            'query': query_preview,
                            'results_count': len(leads),
                            'location': location,
                            'sector': sector_filter,
                            'executive_terms': ', '.join(executive_terms),
                            'alto_potencial': alto_potencial,
                            'medio_potencial': medio_potencial,
                            'baixo_potencial': baixo_potencial,
                            'conversion_rate': round(conversion_rate, 1),
                            'search_params': {
                                'executive_terms': ', '.join(executive_terms),
                                'sector': sector_filter,
                                'location': location,
                                'num_results': num_results,
                                'start_page': start_page
                            }
                        })
                        
                        status_text.markdown(f'<div class="success-msg">‚úÖ Busca conclu√≠da! Encontrados {len(leads)} leads.</div>', unsafe_allow_html=True)
                        progress_bar.empty()
                        
                    else:
                        st.error(f"‚ùå Erro na requisi√ß√£o: {response.status_code}")
                        
                except requests.exceptions.RequestException as e:
                    st.error(f"‚ùå Erro de conex√£o: {str(e)}")

# TAB 2: Resultados
with tab2:
    st.header("üìä Resultados da Busca")
    
    if st.session_state.leads_data:
        # M√©tricas resumo
        col1, col2, col3, col4 = st.columns(4)
        
        # Calcular estat√≠sticas
        total_leads = len(st.session_state.leads_data)
        alto_potencial = len([l for l in st.session_state.leads_data if 'ALTO' in l.get('analise', '')])
        medio_potencial = len([l for l in st.session_state.leads_data if 'M√âDIO' in l.get('analise', '')])
        baixo_potencial = total_leads - alto_potencial - medio_potencial
        
        with col1:
            st.metric("Total de Leads", total_leads, "üéØ")
        with col2:
            st.metric("Alto Potencial", alto_potencial, "üî•")
        with col3:
            st.metric("M√©dio Potencial", medio_potencial, "‚ö°")
        with col4:
            st.metric("Baixo Potencial", baixo_potencial, "üìä")
        
        # Filtros
        st.subheader("üîç Filtrar Resultados")
        col1, col2 = st.columns(2)
        
        with col1:
            potencial_filter = st.selectbox(
                "Filtrar por Potencial",
                ["Todos", "Alto Potencial", "M√©dio Potencial", "Baixo Potencial"]
            )
        
        with col2:
            search_filter = st.text_input("üîç Buscar por nome/empresa")
        
        # Aplicar filtros
        filtered_data = st.session_state.leads_data.copy()
        
        if potencial_filter != "Todos":
            if potencial_filter == "Alto Potencial":
                filtered_data = [l for l in filtered_data if 'ALTO' in l.get('analise', '')]
            elif potencial_filter == "M√©dio Potencial":
                filtered_data = [l for l in filtered_data if 'M√âDIO' in l.get('analise', '')]
            elif potencial_filter == "Baixo Potencial":
                filtered_data = [l for l in filtered_data if 'ALTO' not in l.get('analise', '') and 'M√âDIO' not in l.get('analise', '')]
        
        if search_filter:
            filtered_data = [l for l in filtered_data if search_filter.lower() in l.get('titulo', '').lower()]
        
        # Exibir resultados
        st.subheader(f"üìã Leads Encontrados ({len(filtered_data)})")
        
        for i, lead in enumerate(filtered_data):
            with st.expander(f"üë§ {lead.get('titulo', 'N/A')}", expanded=False):
                col1, col2 = st.columns([3, 1])
                
                with col1:
                    st.write(f"**üîó Link:** {lead.get('link', 'N/A')}")
                    st.write(f"**üìù Resumo:** {lead.get('resumo', 'N/A')}")
                    st.write(f"**ü§ñ An√°lise IA:** {lead.get('analise', 'N/A')}")
                
                with col2:
                    # Determinar cor do potencial
                    potencial_color = "üî•" if "ALTO" in lead.get('analise', '') else "‚ö°" if "M√âDIO" in lead.get('analise', '') else "üìä"
                    st.markdown(f"### {potencial_color} Potencial")
        
        # Bot√µes de a√ß√£o
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üì• Exportar para CSV"):
                df = pd.DataFrame(filtered_data)
                csv = df.to_csv(index=False)
                st.download_button(
                    label="‚¨áÔ∏è Download CSV",
                    data=csv,
                    file_name=f"leads_linkedin_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                    mime="text/csv"
                )
        
        with col2:
            # Bot√£o para abrir planilha do Google Sheets
            planilha_url = "https://docs.google.com/spreadsheets/d/181jPxTxogNrgZKFh8BmEtwEhxsPbOTRUfxYrdox5N2k/edit?usp=sharing"
            st.markdown(f'<a href="{planilha_url}" target="_blank"><button style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">üìä Abrir Planilha</button></a>', unsafe_allow_html=True)
    else:
        st.info("üîç Nenhum resultado encontrado. Execute uma busca primeiro!")

# TAB 3: Analytics
with tab3:
    st.header("üìà Analytics e Insights")
    
    if st.session_state.leads_data:
        # Estat√≠sticas simples
        potencial_counts = {
            'Alto': len([l for l in st.session_state.leads_data if 'ALTO' in l.get('analise', '')]),
            'M√©dio': len([l for l in st.session_state.leads_data if 'M√âDIO' in l.get('analise', '')]),
            'Baixo': len(st.session_state.leads_data) - len([l for l in st.session_state.leads_data if 'ALTO' in l.get('analise', '') or 'M√âDIO' in l.get('analise', '')])
        }
        
        # Mostrar estat√≠sticas
        st.subheader("üìä Distribui√ß√£o por Potencial")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("üî• Alto Potencial", potencial_counts['Alto'])
        with col2:
            st.metric("‚ö° M√©dio Potencial", potencial_counts['M√©dio'])
        with col3:
            st.metric("üìä Baixo Potencial", potencial_counts['Baixo'])
        
        # Insights autom√°ticos
        st.subheader("üß† Insights Autom√°ticos")
        
        total = len(st.session_state.leads_data)
        alto_perc = (potencial_counts['Alto'] / total * 100) if total > 0 else 0
        
        if alto_perc > 30:
            st.success(f"üéØ Excelente! {alto_perc:.1f}% dos leads s√£o de alto potencial!")
        elif alto_perc > 15:
            st.info(f"üëç Bom resultado! {alto_perc:.1f}% dos leads s√£o de alto potencial.")
        else:
            st.warning(f"‚ö†Ô∏è Apenas {alto_perc:.1f}% dos leads s√£o de alto potencial. Considere refinar os crit√©rios de busca.")
    
    else:
        st.info("üìä Execute uma busca para ver analytics!")

# TAB 4: Hist√≥rico
with tab4:
    st.header("üìã Hist√≥rico de Buscas")
    
    if st.session_state.search_history:
        # Estat√≠sticas do hist√≥rico
        total_searches = len(st.session_state.search_history)
        total_leads_found = sum([s['results_count'] for s in st.session_state.search_history])
        avg_leads = total_leads_found / total_searches if total_searches > 0 else 0
        avg_conversion = sum([s.get('conversion_rate', 0) for s in st.session_state.search_history]) / total_searches if total_searches > 0 else 0
        
        # M√©tricas do hist√≥rico
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("Total de Buscas", total_searches)
        with col2:
            st.metric("Total de Leads", total_leads_found)
        with col3:
            st.metric("M√©dia por Busca", f"{avg_leads:.1f}")
        with col4:
            st.metric("Taxa Convers√£o M√©dia", f"{avg_conversion:.1f}%")
        
        # Hist√≥rico detalhado
        st.subheader("üìä Hist√≥rico Detalhado")
        
        for i, search in enumerate(reversed(st.session_state.search_history)):
            with st.expander(f"üîç Busca {len(st.session_state.search_history) - i} - {search['timestamp']}", expanded=False):
                col1, col2 = st.columns([2, 1])
                
                with col1:
                    st.write(f"**üéØ Cargos:** {search['executive_terms']}")
                    st.write(f"**üè≠ Setor:** {search['sector']}")
                    st.write(f"**üìç Local:** {search['location']}")
                    st.write(f"**üìä Total de Leads:** {search['results_count']}")
                    
                    # Distribui√ß√£o por potencial
                    col_a, col_b, col_c = st.columns(3)
                    with col_a:
                        st.metric("üî• Alto", search.get('alto_potencial', 0))
                    with col_b:
                        st.metric("‚ö° M√©dio", search.get('medio_potencial', 0))
                    with col_c:
                        st.metric("üìä Baixo", search.get('baixo_potencial', 0))
                    
                    st.write(f"**üìà Taxa de Convers√£o:** {search.get('conversion_rate', 0)}%")
                
                with col2:
                    st.write("**A√ß√µes:**")
                    
                    # Bot√£o para repetir busca
                    if st.button(f"üîÑ Repetir Busca", key=f"repeat_{i}"):
                        # Extrair par√¢metros da busca
                        search_params = search.get('search_params', {})
                        
                        # Simular repeti√ß√£o da busca
                        st.info("üîÑ Repetindo busca com os mesmos par√¢metros...")
                        st.write("**Par√¢metros da busca:**")
                        for key, value in search_params.items():
                            st.write(f"- {key}: {value}")
                        
                        # Voc√™ pode implementar aqui a l√≥gica real para repetir a busca
                        # Por exemplo, definindo os valores no session_state e redirecionando
                        st.warning("üí° **Dica:** Copie os par√¢metros acima e cole na aba 'Buscar Leads'")
                    
                    # Bot√£o para ver detalhes
                    if st.button(f"üëÅÔ∏è Ver Query", key=f"query_{i}"):
                        st.code(search.get('query', 'Query n√£o dispon√≠vel'))
        
        # An√°lise de tend√™ncias
        st.subheader("üìà An√°lise de Tend√™ncias")
        
        if len(st.session_state.search_history) > 1:
            # Preparar dados para an√°lise
            df_history = pd.DataFrame(st.session_state.search_history)
            
            # M√©dia de leads por localiza√ß√£o
            if 'location' in df_history.columns:
                location_stats = df_history.groupby('location').agg({
                    'results_count': 'mean',
                    'conversion_rate': 'mean'
                }).round(1)
                
                st.write("**üìç Performance por Localiza√ß√£o:**")
                for location, stats in location_stats.iterrows():
                    st.write(f"- {location}: {stats['results_count']} leads/busca ({stats['conversion_rate']}% convers√£o)")
            
            # M√©dia de leads por setor
            if 'sector' in df_history.columns:
                sector_stats = df_history.groupby('sector').agg({
                    'results_count': 'mean',
                    'conversion_rate': 'mean'
                }).round(1)
                
                st.write("**üè≠ Performance por Setor:**")
                for sector, stats in sector_stats.iterrows():
                    st.write(f"- {sector}: {stats['results_count']} leads/busca ({stats['conversion_rate']}% convers√£o)")
        
        # Bot√£o para limpar hist√≥rico
        st.subheader("üóëÔ∏è Gerenciar Hist√≥rico")
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üóëÔ∏è Limpar Hist√≥rico"):
                st.session_state.search_history = []
                st.success("‚úÖ Hist√≥rico limpo!")
                st.rerun()
        
        with col2:
            # Bot√£o para exportar hist√≥rico
            if st.button("üì• Exportar Hist√≥rico"):
                df_export = pd.DataFrame(st.session_state.search_history)
                csv_export = df_export.to_csv(index=False)
                st.download_button(
                    label="‚¨áÔ∏è Download Hist√≥rico CSV",
                    data=csv_export,
                    file_name=f"historico_buscas_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                    mime="text/csv"
                )
    
    else:
        st.info("üìù Nenhuma busca realizada ainda.")

# Footer
st.markdown("---")
st.markdown(
    """
    <div style='text-align: center; color: #666; padding: 1rem;'>
        üöÄ LinkedIn Lead Generator - Powered by N8N & Streamlit<br>
        Developed with ‚ù§Ô∏è for efficient lead generation
    </div>
    """,
    unsafe_allow_html=True
)